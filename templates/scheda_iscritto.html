{% extends "base.html" %}
{% block title %}Scheda Personale{% endblock %}

{% block content %}

<style>
    .profile-container {
        max-width: 1300px;
        margin: auto;
        margin-top: 10px;
        padding: 80px;
        background: #ffffffee;
        border-radius: 28px;
        box-shadow: 0 10px 36px rgba(0,0,0,0.28);
    }

    .profile-title {
        font-size: 3.4rem;
        font-weight: 900;
        text-align: center;
        margin-bottom: 50px;
        color: #002b5c;
    }

    .data-label {
        font-weight: 800;
        color: #002b5c;
        font-size: 2.2rem;
    }

    .data-value {
        font-size: 2.2rem;
        margin-bottom: 30px;
    }

    .table-corsi th {
        background: #002b5c;
        color: white;
        font-size: 1.3rem;
        text-align: center;
    }

    .table-corsi td {
        font-size: 1.3rem;
        vertical-align: middle;
        text-align: center;
    }

    .badge {
        font-size: 1.1rem;
        padding: 10px 14px;
    }

    .btn-notifiche {
        font-size: 1.8rem;
        padding: 18px 32px;
        margin-left: 40px;
        margin-top: 10px;
        border-radius: 12px;
    }
</style>

<div class="profile-container">

    <div class="profile-title">Scheda Personale</div>

    <p><span class="data-label">Nome:</span>
       <span class="data-value">{{ dati.nome }}</span></p>

    <p><span class="data-label">Cognome:</span>
       <span class="data-value">{{ dati.cognome }}</span></p>

    <p><span class="data-label">Data di nascita:</span>
       <span class="data-value">{{ dati.data_nascita }}</span></p>

    <p><span class="data-label">Indirizzo:</span>
       <span class="data-value">{{ dati.indirizzo }}</span></p>

    <p><span class="data-label">Telefono:</span>
       <span class="data-value">{{ dati.telefono }}</span></p>

    <p><span class="data-label">Email:</span>
       <span class="data-value">{{ dati.email }}</span></p>

    <p><span class="data-label">Categoria:</span>
       <span class="data-value">{{ dati.categoria }}</span></p>

    <p>
        <span class="data-label">Attiv. Notifiche:</span>
        {% if dati.notifiche_attive %}
            <span class="data-value" style="color:green;font-weight:800;">ATTIVE</span>
        {% else %}
            <span class="data-value" style="color:red;font-weight:800;">NON ATTIVE</span>
        {% endif %}
    </p>

    {% if not dati.notifiche_attive %}
    <button class="btn btn-success btn-notifiche" onclick="attivaNotifiche()">
        ðŸ”” Attiva notifiche di emergenza
    </button>
    {% else %}
    <button class="btn btn-danger btn-notifiche" onclick="disattivaNotifiche()">
        ðŸ”• Disattiva notifiche
    </button>
    {% endif %}

    <hr>

    <h3 class="mt-4 mb-3">Corsi svolti</h3>

    <table class="table table-bordered table-corsi">
        <thead>
            <tr>
                <th>Corso</th>
                <th>Completato</th>
                <th>Scadenza</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Motosega</td>
                <td><span class="badge bg-{{ dati.col_motosega }}">{{ "SÃ¬" if dati.motosega else "No" }}</span></td>
                <td><span class="badge bg-{{ dati.col_motosega }}">{{ dati.scadenza_motosega }}</span></td>
            </tr>

            <tr>
                <td>Corso Base PC</td>
                <td><span class="badge bg-{{ dati.col_base }}">{{ "SÃ¬" if dati.corso_base else "No" }}</span></td>
                <td><span class="badge bg-{{ dati.col_base }}">{{ dati.scadenza_base }}</span></td>
            </tr>

            <tr>
                <td>Altro</td>
                <td><span class="badge bg-{{ dati.col_altro }}">{{ "SÃ¬" if dati.altro_fatto else "No" }}</span></td>
                <td><span class="badge bg-{{ dati.col_altro }}">{{ dati.scadenza_altro }}</span></td>
            </tr>

            <tr>
                <td>Corso 4</td>
                <td><span class="badge bg-secondary">{{ "SÃ¬" if dati.corso_4 else "No" }}</span></td>
                <td><span class="badge bg-secondary">{{ dati.scadenza_corso_4 }}</span></td>
            </tr>

            <tr>
                <td>Corso 5</td>
                <td><span class="badge bg-secondary">{{ "SÃ¬" if dati.corso_5 else "No" }}</span></td>
                <td><span class="badge bg-secondary">{{ dati.scadenza_corso_5 }}</span></td>
            </tr>

            <tr>
                <td>Corso 6</td>
                <td><span class="badge bg-secondary">{{ "SÃ¬" if dati.corso_6 else "No" }}</span></td>
                <td><span class="badge bg-secondary">{{ dati.scadenza_corso_6 }}</span></td>
            </tr>
        </tbody>
    </table>

</div>

<!-- ðŸ”¥ VARIABILI NECESSARIE PER LE NOTIFICHE -->
<script>
    const vapidPublicKey = "{{ vapid_public_key }}";
    const telefonoUtente = "{{ dati.telefono }}";
    const categoriaUtente = "{{ dati.categoria }}";
</script>

<!-- ðŸ”¥ FUNZIONE DI CONVERSIONE VAPID -->
<script>
function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');

    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);

    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}
</script>

<!-- ðŸ”” ATTIVA NOTIFICHE -->
<script>
async function attivaNotifiche() {

    const perm = await Notification.requestPermission();
    if (perm !== "granted") {
        alert("Permesso notifiche negato");
        return;
    }

    const registration = await navigator.serviceWorker.ready;

    const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
    });

    const body = {
        endpoint: subscription.endpoint,
        p256dh: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey("p256dh")))),
        auth: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey("auth")))),
        telefono: telefonoUtente,
        gruppo: categoriaUtente
    };

    fetch("/subscribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    })
    .then(() => {
        alert("Notifiche attivate correttamente");
        location.reload();
    });
}
</script>

<!-- ðŸ”• DISATTIVA NOTIFICHE -->
<script>
async function disattivaNotifiche() {

    await fetch("/unsubscribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telefono: telefonoUtente })
    });

    alert("Notifiche disattivate");
    location.reload();
}
</script>

<!-- ðŸ”¥ REGISTRAZIONE SERVICE WORKER -->
<script>
navigator.serviceWorker.register("/service-worker.js")
    .then(() => console.log("Service worker registrato"))
    .catch(err => console.error("Errore registrazione SW:", err));
</script>

{% endblock %}