{% extends "base.html" %}
{% block title %}Emergenze{% endblock %}

{% block content %}

<style>
    .emergenza-wrapper {
        max-width: 700px;
        margin: 0 auto;
        margin-top: 40px;
        text-align: center;
        animation: fadeIn 0.6s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .emergenza-card {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        margin-bottom: 30px;
    }

    .emergenza-title {
        font-size: 2rem;
        font-weight: 800;
        color: #b30000;
        margin-bottom: 20px;
    }

    .emergenza-btn {
        width: 100%;
        padding: 20px;
        font-size: 1.6rem;
        font-weight: 700;
        border-radius: 16px;
        margin-bottom: 15px;
        display: block;
        text-decoration: none;
        color: white;
        transition: transform 0.15s ease;
    }

    .emergenza-btn:hover {
        transform: scale(1.03);
    }

    .btn-allerta {
        background: #d40000;
        box-shadow: 0 4px 12px rgba(212,0,0,0.4);
    }

    .btn-stato {
        background: #ff8c00;
        box-shadow: 0 4px 12px rgba(255,140,0,0.4);
    }

    .btn-procedure {
        background: #005bbb;
        box-shadow: 0 4px 12px rgba(0,91,187,0.4);
    }

    .btn-reset {
        background: #2e8b57;
        box-shadow: 0 4px 12px rgba(46,139,87,0.4);
    }

    .info-box {
        background: #fff8d9;
        border-left: 6px solid #ffcc00;
        padding: 20px;
        border-radius: 12px;
        text-align: left;
    }

    .info-box h4 {
        font-weight: 700;
        margin-bottom: 10px;
    }

    .stato-box {
        background: #eef3ff;
        border-left: 6px solid #005bbb;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        text-align: left;
    }

    .stato-box strong {
        font-size: 1.2rem;
    }
</style>

<div class="emergenza-wrapper">

    <!-- ðŸ”µ STATO ATTUALE ALLERTA -->
    <div class="stato-box">
        <strong>Stato attuale dellâ€™allerta:</strong>
        <p id="stato-attuale">Caricamento...</p>
    </div>

    <div class="emergenza-card">
        <div class="emergenza-title">Gestione Emergenze</div>

        <!-- ðŸš¨ INVIA ALLERTA (POST) -->
        <a href="#" onclick="inviaAllerta()" class="emergenza-btn btn-allerta">
            ðŸš¨ INVIA ALLERTA
        </a>

        <a href="#" class="emergenza-btn btn-stato">
            ðŸ“Š AGGIORNA STATO ALLERTA
        </a>

        <a href="#" class="emergenza-btn btn-procedure">
            ðŸ“˜ PROCEDURE OPERATIVE
        </a>

        <!-- ðŸŸ¢ RIPRISTINA STATO VERDE -->
        <a href="#" onclick="resetAllerta()" class="emergenza-btn btn-reset">
            âœ… RIPRISTINA STATO VERDE
        </a>
    </div>

    <div class="info-box">
        <h4>Informazioni</h4>
        <p>
            Da questa pagina puoi gestire le comunicazioni di emergenza verso i volontari.
            Le funzioni includono:
        </p>
        <ul>
            <li><strong>Invio allerta immediata</strong> tramite Notifica Web</li>
            <li><strong>Aggiornamento del livello di allerta</strong> (verde, gialla, arancione, rossa)</li>
            <li><strong>Accesso rapido alle procedure operative</strong> della Protezione Civile VAS</li>
        </ul>
    </div>

</div>

<!-- ðŸ”¥ SCRIPT: mostra stato attuale + reset -->
<script>
function aggiornaStato() {
    fetch("/api/allerta")
        .then(r => r.json())
        .then(data => {
            const stato = document.getElementById("stato-attuale");

            let colore = data.colore || "verde";
            let messaggio = data.messaggio || "";

            stato.innerHTML = `
                <strong>Colore:</strong> ${colore.toUpperCase()}<br>
                <strong>Messaggio:</strong> ${messaggio || "Nessun messaggio"}
            `;
        });
}

function resetAllerta() {
    fetch("/api/reset_allerta", { method: "POST" })
        .then(r => r.text())
        .then(() => {
            alert("Allerta ripristinata allo stato verde");
            aggiornaStato();
        });
}

setInterval(aggiornaStato, 5000);
aggiornaStato();
</script>

<!-- ðŸ”¥ INVIO ALLERTA PUSH -->
<script>
function inviaAllerta() {
    const messaggio = prompt("Inserisci il messaggio di allerta:", "ðŸš¨ ALLERTA METEO ARANCIONE");

    if (!messaggio) return;

    fetch("/invia_allerta", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messaggio: messaggio })
    })
    .then(r => r.text())
    .then(res => {
        alert("Notifiche inviate: " + res);
    })
    .catch(err => console.error(err));
}
</script>

{% endblock %}